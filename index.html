<!DOCTYPE html>
<html>

<head>
    <title>A D3 map</title>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script src='js/neighborhoods.js'></script>
    <script src='js/locations.js'></script>
    <style>
        svg {
            padding-top: 50px;
            display: block;
            margin: auto;
        }

        h2 {
            text-align: center;
            font: 30px sans-serif;
        }

        text {
            font: 15px sans-serif;
            fill: #1f77b4;
        }
    </style>
</head>

<body>
    <h2>Map of North Boston</h2>
    <script>
        var cab_data;
        window.onload = function () {
            d3.csv('./data/clean_cab_rides.csv')
                .then(function (data) {
                    cab_data = data
                    build()
                })

            var width = 700,
                height = 580;

            // zoom into map to show the points we drew more clearly
            var albersProjection = d3.geoAlbers()
                .scale(780000)
                .rotate([71.057, 0])
                .center([-.021, 42.353])
                .translate([width / 2, height / 2]);

            function build() {
                var svg = d3.select('body')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                svg.append('rect')
                    .attr('width', '100%')
                    .attr('height', '100%')
                    .attr('fill', 'lightblue')

                // draw map of boston
                var g = svg.append('g');


                var geoPath = d3.geoPath()
                    .projection(albersProjection);

                g.selectAll('path')
                    .data(neighborhoods_json.features)
                    .enter()
                    .append('g')
                    .append('path')
                    .attr('fill', '#c9d3cd')
                    .attr('d', geoPath)
                    .style("stroke", "#fff")
                    .style("stroke-width", "1.2")

                // draw locations using circles from cab data on map
                var lines = svg.append('g')
                    .attr('id', 'lines');

                var locations = svg.append('g')
                    .attr('id', 'circles');

                locations.selectAll('circle')
                    .data(locations_json.features)
                    .enter()
                    .append('g')
                    .on('mouseover', function (d) {
                        addLines(svg, d.Name, d.geometry.coordinates, albersProjection, locations_json, this, lines)
                        d3.select(this)
                            .attr('fill', 'brown')
                        // .append('text')
                        //     .text((d) => d.Name)
                        //     .attr('x', (d) => +albersProjection(d.geometry.coordinates)[0] - 40)
                        //     .attr('y', (d) => +albersProjection(d.geometry.coordinates)[1] - 25)

                    })
                    .on('mouseout', function (d) {
                        d3.select('text').remove();
                        d3.select('#lines').html("");
                    })
                    .append('circle')
                    .attr('fill', '#1f77b4')
                    .attr('r', 13)
                    .attr('cx', (d) => albersProjection(d.geometry.coordinates)[0])
                    .attr('cy', (d) => albersProjection(d.geometry.coordinates)[1])
                    .on('mouseover', function (d) {
                        d3.select(this)
                            .attr('fill', 'brown')
                    })
                    .on('mouseout', function (d) {
                        d3.select(this)
                            .attr('fill', '#1f77b4')
                    });
            }

            // draws lines from origin to destination, line width is  determined by number of rides
            // from->to origin to destination
            function addLines(svg, name, origin, projection, loc_json, object, lines) {
                // filter data based on selected location
                data = cab_data.filter((d) => d.source == name)

                // rollup data to get sum of rides from location to destinations
                var rides = d3.nest()
                    .key(function (d) { return d.destination; })
                    .rollup(function (v) {
                        return {
                            value: v.length,
                            avg: d3.mean(v, (e) => e.price)
                        }
                    })
                    .entries(data);
                // draw lines to destinations
                lines.selectAll('line')
                    .data(rides)
                    .enter()
                    .append('line')
                    .attr('x1', +projection(origin)[0])
                    .attr('y1', +projection(origin)[1])
                    .attr('x2', (d) => projection(loc_json.features[numToLoc[d.key]].geometry.coordinates)[0])
                    .attr('y2', (d) => projection(loc_json.features[numToLoc[d.key]].geometry.coordinates)[1])
                    .attr('stroke', 'red')
                    .attr('stroke-width', (d) => +d.value.value / 1000)

                lines.append("text")
                    .attr("dy", ".75em")
                    .attr("x", +albersProjection(origin)[0] - 40)
                    .attr("y", +albersProjection(origin)[1] - 25)
                    .text(name)
            }
        }
    </script>
</body>

</html>